---
output:
  html_document: default
  word_document: default
---

## **Reports in R Markdown**

[![License: CC BY 4.0](https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg)](https://creativecommons.org/licenses/by/4.0/deed.de)

*"Reports in R Markdown" von Lisa Reiber in "R Lernen - der Datenkurs von und f√ºr die Zivilgesellschaft" von CorrelAid e.V. Lizensiert unter [Creative Commons Attribution 4.0 International](https://creativecommons.org/licenses/by/4.0/deed.de).*

![*Video: Reports in RMarkdown (45min)*](https://youtu.be/VUQseeP65t8)

### **Kernaussagen**

-   R Markdown ist ein **Framework**, das es erm√∂glicht, **reproduzierbare Reports** mit R Code zu schreiben

-   R Markdown ist so beliebt, weil es erm√∂glicht **alle Schritte einer Datenanalyse an einem Ort** zu sammeln. Dadurch werden Pr√§sentationen verst√§ndlicher und bei R√ºckblicken kann auf Anmerkungen und Erkl√§rungen zu Analysen zur√ºckgeriffen werden :

    -   Einleitung und Fragestellung (Text)
    -   Daten importieren, bereinigen & analysieren (Code)
    -   Ergebnisse darstellen, z.B. Tabellen oder Plots (Code Output)
    -   Ergebnisse interpretieren (Text)
    -   Zusammenfassung (Text)

-   Die **Code Chunks**, in den Code steht und die Code Output erzeugen, sind in Rmds **grau** hinterlegt, w√§hrend der **Markdown-Teil wei√ü** hinterlegt ist

-   Au√üerdem k√∂nnt Ihr **berechnete Kennzahlen** integrieren, die bei der Aktualisierung der Daten, wie der restliche Code Output, automatisch geupdatet werden

-   Der Export Eures Reports ist in PDFs, HTML und Word m√∂glich. F√ºr **statistische Reports** ist das **PDF** meistens die richtige Wahl, aber auch eine **HTML**-Datei kann Sinn machen

-   R-Studio bietet eine sehr gute [**Hilfeseite**](https://rmarkdown.rstudio.com/lesson-1.html){target="_blank"} zu vielen Themen rund um R Markdown in englischer Sprache an - unter anderem ein tolles Einf√ºhrungsvideo (1min)

-   Daneben gibt es auch noch diesen [**Schummelzettel (dt.)**](https://github.com/CorrelAid/lernplattform/blob/main/cheatsheets/09_cheatsheet-rmarkdown-2.pdf){target="_blank"}, diesen [**Schummelzettel (engl.)**](https://github.com/CorrelAid/lernplattform/blob/main/cheatsheets/09_cheatsheet-rmarkdown-1.pdf){target="_blank"} und dieses tolle [**Nachschlagewerk (engl.)**](https://github.com/CorrelAid/lernplattform/blob/main/cheatsheets/09_cheatsheet-rmarkdown-3.pdf){target="_blank"}

### **Quiz**

```{r 10quiz_reports_allg}
quiz(caption = NULL,
  question("Welche diese Beschreibungen treffen zu? R Markdown ist... ",
    answer("...üì¶ ein R-Paket namens rmarkdown.", correct = TRUE),
    answer("...Ô∏èZauberei üßô"),
    answer("...ein Dateiformat zum Erstellen dynamischer Dokumente mit R.", correct = TRUE),
    answer("...ein Tool zum Integrieren von Prosa, Code und Ergebnissen.", correct = TRUE),
    correct = "Richtig!",
    incorrect = "Leider falsch: Versuche es einfach nochmal oder schau im Video nach!",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"),
  question("Die drei Hauptkomponenten, aus denen sich R Markdown Dateien zusammensetzen, sind:",
    answer("YAML Abschnitt, Inhalt und Code Chunks", correct = TRUE),
    answer("√úberschriften, Texte und Bilder"),
    answer("Code, Tabellen und Grafiken"),
    answer("R, Mark und Down"),
    correct = "Richtig!",
    incorrect = "Leider falsch: Versuche es einfach nochmal oder schau im Video nach!",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  )
)
```

### **Interaktive √úbung**

#### 1. Markdown (Inhalt)

In R Markdown Dateien steht das **md** in der Dateiendung `meine_datei.Rmd` f√ºr **Markdown.** Markdown (ohne R) ist eine einfache M√∂glichkeit, Text zu formatieren, der auf allen Ger√§ten gut aussieht. Auch unsere Lernplattform basiert auf Markdown.

Die Formatierung funktioniert nur in dem **wei√ü hinterlegten Teil** des Rmds, dem Textteil. Mit wenigen Zeichen k√∂nnt Ihr dort folgende Formatierungen vornehmen:

| **Formatierung**              | **Erstellt mit:**                                                  | *Anmerkung*                                                                                                                                                                        |
|--------------------------|---------------------------|-------------------|
| **H5 √úberschrift**            | `##### H5 √úberschrift`                                             | *Anmerkung: H1 √úberschriften ben√∂tigen nur ein #, H2 zwei ##, usw.*                                                                                                                |
| **Trennlinie**                | `---`                                                              | *auf ausreichend Zeilenumbr√ºche davor und danach achten.*                                                                                                                          |
| **Text**                      | `*Text in italics*`                                                | wird zu *Text in italics*                                                                                                                                                          |
| **Text**                      | `**Text in bold**`                                                 | wird zu **Text in bold**                                                                                                                                                           |
| **Einf√ºgen eines Bildes**     | `![Bildbeschriftung](Link%20zum%20Bild){width="10%" height="10%"}` | ![Bild: Logo CorrelAid](https://betterplace-assets.betterplace.org/uploads/organisation/profile_picture/000/033/251/crop_original_bp1613490681_Logo.jpg){width="10%" height="10%"} |
| **Einf√ºgen eines Hyperlinks** | `[Hyperlinkname](Link){target="_blank"}`                           | *Mit {target="\_blank"} k√∂nnt Ihr festlegen, dass ein neuer Tab ge√∂ffnet wird.*                                                                                                    |
| **Zeilenumbr√ºche**            | `<br>`                                                             | *Notation stammt aus HTML*                                                                                                                                                         |
| **Positionierung**            | `<center>, <left> und <right>`                                     | *Ebenfalls HTML-Notation*                                                                                                                                                          |
| **Backslash**                 | `\`                                                                | \*ignoriert Bedeutung von Sonderzeichen, wenn der Backslash vor ihnen steht                                                                                                        |

```{r 10quiz_reports_markdown}
quiz(caption = NULL,
  question("Wie formatiert Ihr Text zu einer √úberschrift?",
    answer("Der gew√ºnschten Anzahl an Hashes (#), eins f√ºr H1, zwei f√ºr H2, ...", correct = TRUE),
    answer("Zwei Sternchen (**) vor und hinter der √úberschrift"),
    answer("Ein Sternchen (*) vor und hinter der √úberschrift"),
    answer("Einen Backslash vor und hinter der √úberschrift"),
    answer("Durch das Umschlie√üen der √úberschrift mit eckigen Klammern ([])"),
    correct = "Richtig!",
    incorrect = "Leider falsch: Versuche es einfach nochmal!",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  )
)
```

Wenn Ihr noch ein bisschen √ºben wollt, wie Ihr Text mit Hilfe von der Markdown Syntax formatieren k√∂nnt, gibt es hier ein [10-minutes interaktives Tutorial in englischer Sprache](https://commonmark.org/help/), welches wir sehr empfehlen k√∂nnen.

#### 2. R Code Bl√∂cke (Chunks)

Code Bl√∂cke werden in Eurem Rmd's **grau hinterlegt**. Ihr k√∂nnt sie mit

-   der Tastenkombination Strg + Alt + I (OS X: Cmd + Wahl + I) oder
-   dem Befehl `Chunk hinzuf√ºgen` in der Symbolleiste des Editors (gr√ºnes C+)

in Eure Rmd-Datei einf√ºgen.

Je nachdem wie Ihr Euer Rmd gestalten wollt, m√ºsst Ihr die Code Block **Argumente** setzen. Dazu setzt Ihr im Code Chunk innerhalb der geschwungenen Klammer ein Argument und erg√§nzt dann auf der rechten Seite die richtige Einstellung. Mehrere Argumente werden durch Kommata (",") getrennt. <br>

\`\`\`{r, argument1 = gew√ºnschte_einstellung, ...} <br> Dein Code hier <br> \`\`\` <br>

Grunds√§tzlich wird in Eurem Outputformat **aller Code, s√§mtlicher Code Output, alle Nachrichten und Warnungen** integriert. Nicht immer ist das gew√ºnscht. Die wichtigsten Argumente findet Ihr deshalb hier:

| **Argumente**     | **Bedeutung**                                                                                                                                                                                       |
|------------------------------------|------------------------------------|
| `include = FALSE` | definiert, dass **Code und Code Output** in der fertigen Datei **nicht erscheinen**. R Markdown f√ºhrt den Code weiterhin im Chunk aus und die Ergebnisse k√∂nnen von anderen Chunks verwendet werden |
| `echo = FALSE`    | definiert, dass **Code nicht angezeigt wird**, aber Code Output (wie Tabellen und Plots) in der fertigen Datei erscheinen. Dies ist eine n√ºtzliche Methode zum **Einbetten von Abbildungen**        |
| `message = FALSE` | verhindert, dass **Nachrichten**, die bei der Ausf√ºhrung des Codes generiert werden, in der fertigen Datei erscheinen                                                                               |
| `warning = FALSE` | verhindert, dass **Warnungen**, die bei der Ausf√ºhrung des Codes generiert werden, im Report erscheinen                                                                                             |
| `fig.cap = "..."` | f√ºgt den grafischen Ergebnissen eine **Beschriftung** hinzu                                                                                                                                         |

Um eine Option f√ºr alle Code Blocks festzulegen, kann sie **global im ersten Setup Code Block** mit der Funktion `knitr::opts_chunk$set(argument = ...)` gesetzt werden. <br>

\`\`\`{r setup, include=FALSE} <br> knitr::opts_chunk\$set(argument1 = gew√ºnschte_einstellung, ...) <br> \`\`\` <br>

Knitr behandelt jede Option, die an knitr::opts_chunk\$set √ºbergeben wurde, als globalen Standard, der **in einzelnen Chunk-Headern √ºberschrieben** werden kann.

```{r 10quiz_reports_codechunksettings, echo=FALSE, message=FALSE, warning=FALSE}
quiz(caption = NULL,
  question("Grunds√§tzlich m√∂chtet Ihr nicht, dass Code, Nachrichten und Warnungen in Eurem PDF-Outputformat angezeigt werden (also nur der Output sichtbar ist). Was m√ºsst Ihr tun?",
    answer("Im Set-Up Chunk setzen wir die Argumente include, echo, message und warning auf FALSE"),
    answer("Im Set-Up Chunk setzen wir die Argumente echo, message und warning auf FALSE", correct = TRUE),
    answer("Im Set-Up Chunk setzen wir die Argumente include, echo, message und warning auf TRUE"),
    answer("Im Code-Chunk setzen wir die Argumente echo, message und warning auf FALSE"),
    correct = "Richtig! Die Argumente setzen wir dann innerhalb der Funktion knitr::opts_chunk$set().",
    incorrect = "Leider falsch: F√ºr globale Einstellungen nutzen wir den Set-Up-Chunk und definieren innerhalb von knitr::opts_chunk$set() die Argumente wie gew√ºnscht. Hier sind das echo, message und warning, die alle auf FALSE gesetzt werden m√ºssen.",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  ),
  question("Ausnahmsweise soll nun einmal der Code gezeigt werden. Was m√ºsst Ihr tun?",
    answer("Im betroffenen Code Chunk setzen wir das Argument echo auf TRUE", correct = TRUE),
    answer("Im betroffenen Code Chunk setzen wir das Argument echo auf FALSE"),
    answer("Im betroffenen Code Chunk setzen wir das Argument include auf FALSE"),
    answer("Im betroffenen Code Chunk setzen wir das Argument include auf TRUE"),
    correct = "Richtig!",
    incorrect = "Leider falsch: Wir m√ºssen das Argument echo muss auf TRUE gestellt werden. Mit dem Argument include wird √ºbrigens definiert, ob Code und Code Output in das Outputdokument integriert werden sollen. Dieses muss auf TRUE gestellt werden, wenn das geschehen soll, und auf auf FALSE, wenn es nicht geschehen soll.",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  )
)
```

#### 3. YAML Kopfzeile

In der YAML Kopfzeile k√∂nnen verschiedene Meta-Parameter festgelegt werden, die f√ºr die Verarbeitung der R Markdown Datei wichtig sind.

Die **Grundeinstellungen** geben Titel, Autor:in, Datum und Outputformat des geknitteten Dokuments an. Mit vorgefertigten Themes k√∂nnt ihr einfach ein Layout ausw√§hlen. Wenn Ihr Euch mit HTML und CSS auskennt, k√∂nnt ihr Stylesheets anlegen und auf diese verweisen.

Der YAML Abschnitt ist immer zu Beginn einer R Markdown Datei und daran zu erkennen, dass er mit `---` umschlossen ist:

```         
---
title: "Euer Titel"
date: "Datum"
output: html_document
---
```

Im untenstehenden YAML Code wird eimes der Standard Themes von R Markdown namens "Flatly" definiert. Weitere Themes findest du in dieser [R Markdown Theme Gallery](https://www.datadreaming.org/post/r-markdown-theme-gallery/){target="_blank"}.

```         
---
title: "Euer Titel"
date: "Datum"
output: 
  html_document:
    theme: "flatly"
    highlight: github
---
```

```{r 10quiz_reports_yaml}
quiz(caption = NULL,
  question("Im YAML-Header k√∂nnen welche Einstellungen getroffen werden?",
    answer("Titel des Outputdokuments", correct = TRUE),
    answer("Autor:in des Outputdokuments", correct = TRUE),
    answer("Datum des Outputdokuments", correct = TRUE),
    answer("Dateiformat", correct = TRUE),
    answer("Layout", correct = TRUE),
    answer("...und vieles mehr!", correct = TRUE),
    correct = "Richtig! Der YAML-Header √ºbernimmt in Rmds zahlreiche Funktionen rund um Styling und Layout.",
    incorrect = "Leider falsch: Alles davon kann im YAML-Header festgelegt werden!",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  )
)
```

### **Und jetzt Ihr**

1.  **Lasst Euch inspirieren**: Besucht die [R-Studio R Markdown Galerie](https://rmarkdown.rstudio.com/gallery.html){target="_blank"} und st√∂bert durch einige Beispiele, die mit R Markdown erstellt wurden. Ihr k√∂nnt zwischen Webseiten, PDF-Dokumenten oder Dashboards, Slideshows uvm. w√§hlen. Teilt Euer Lieblingsbeispiel (als Screenshot und/oder mit Link) im Slack Channel und beschreibt in 1-3 S√§tzen, was Ihr an dem Report besonders gelungen findet.
2.  Bearbeitet lokal die **√úbung 09_reports-uebung.Rmd** im [√úbungsordner](https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/CorrelAid/lernplattform/tree/main/uebungen){target="_blank"} unter 09_reports zu R Markdown, die wir f√ºr Euch vorbereitet haben.

### **Zus√§tzliche Ressourcen**

-   [**Schummelzettel (dt.)**](https://github.com/CorrelAid/lernplattform/blob/main/cheatsheets/09_cheatsheet-rmarkdown-2.pdf){target="_blank"}
-   [**Nachschlagewerk zu RMarkdown (engl.)**](https://github.com/CorrelAid/lernplattform/blob/main/cheatsheets/09_cheatsheet-rmarkdown-3.pdf){target="_blank"}
-   R-Studio bietet eine sehr gute [**Hilfeseite**](https://rmarkdown.rstudio.com/lesson-1.html){target="_blank"}
-   Templates f√ºr [PDF- und HTML-Dokumente](https://www.rstudio.com/blog/r-markdown-custom-formats/){target="_blank"}

## **Exkurs 1: Reportautomatisierung**

<details>

<summary>**Exkurs 1: Reportautomatisierung**</summary>

[![License: CC BY 4.0](https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg)](https://creativecommons.org/licenses/by/4.0/deed.de)

*"Reportautomatisierung" von Lisa Reiber in "R Lernen - der Datenkurs von und f√ºr die Zivilgesellschaft" von CorrelAid e.V. Lizensiert unter [Creative Commons Attribution 4.0 International](https://creativecommons.org/licenses/by/4.0/deed.de).*

![*Video: Reportautomatisierung (20min)*](https://youtu.be/78r2ugQ6bdQ)

### **Kernaussagen**

-   Berichte in R Markdown anzulegen, bedeutet, **reproduzierbare Reports** zu erstellen
-   So k√∂nnen...
    a)  Reports leicht **aktualisiert**,
    b)  **verschiedene Layoutformate** gleichzeitig und
    c)  **eine hohe Anzahl** von Berichten pro **Auspr√§gung einer Entit√§t** (z.B. L√§nder und Zeitr√§ume) erstellt werden
-   In dieser **Flexibilit√§t** von R Markdowns liegt auch ihr Mehrwert
-   Technisch ist daf√ºr zumeist das Verwenden von **Parametern** (zu dt. auch √úbergabewerte) notwendig
-   Parameter sind Variablen, die in Computerprogrammen **verschiedene Auspr√§gungen** annehmen k√∂nnen und f√ºr die Art und Weise der **Verarbeitung** von Informationen in Routinen relevant sind (z.B. wenn individuelle Reports f√ºr verschiedene Beobachtungen erstellt werden)
-   Parameter werden im **YAML-Abschnitt** von R Markdown Dokumenten definiert
-   Sie k√∂nnen √ºber eine Anpassung des YAML-Abschnitt selbst oder innerhalb der **Renderfunktion** `rmarkdown::render("MyDocument.Rmd", params = ...)` adaptiert werden
-   F√ºr Nutzer:innen kann zudem die Auswahl √ºber **interaktive Men√ºs** erm√∂glicht werden (**Men√º-Option** `Knit -> Knit with parameters` oder `rmarkdown::render(input = ..., params = "ask")`)
-   Innerhalb des R Markdowns kann auf die selbst benannten Parameter √ºber `params$parameter_name` **zugegriffen** werden
-   M√∂glich ist die Festlegung von Parametern von den folgenden **Typen**: `character` (Text), `integer` (ganze Zahl), `numeric` (Zahl), `logical` (logischer Ausdruck) und Ausdr√ºcke in R

### **Quiz**

```{r 11quiz_reportauto}
quiz(caption = NULL,
  question("R Markdowns sind reproduzierbar. Das hat den Vorteil, dass...",
    answer("sie leicht aktualisiert werden k√∂nnen.", correct = TRUE),
    answer("in verschiede Layoutformate √ºbertragen werden k√∂nnen.", correct = TRUE),
    answer("sie f√ºr verschiedene Szenarien erstellt werden k√∂nnen.", correct = TRUE),
    answer("problemlos auf v√∂llig andere Daten √ºbertragen werden k√∂nnen."),
    correct = "Richtig!",
    incorrect = "Leider falsch: Die Operationen, die Ihr auf Basis von Daten durchf√ºhrt, sind in den meisten F√§llen auf den Datensatz angestimmt. Daher ist es shr wahrscheinlich, dass der gleiche Code nicht mit einem v√∂llig anderen Datengrundlage funktioniert. Die Struktur der Daten sollte deshalb konstant sein, insbesondere wenn Ihr den Bericht parametrisieren wollt.",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  ),
  question("Der Mehrwert von R Markdowns liegt in...",
    answer("der leichten Anpassungsf√§higkeit ihrer Designs."),
     answer("ihrer Reproduzierbarkeit.", correct = TRUE),
     answer("ihrem niedrigschwelligen User Interface f√ºr nicht so tech-affine Nutzer:innen."),
     correct = "Richtig! Gl√ºcklicherweise gibt es tolle Layouttemplates und die M√∂glichkeit der interaktiven Parametrisierung durch GUIs, die es uns vereinfachen, Reports anschaulich und nutzerinnenfreundlich zu gestalten.",
     incorrect = "Leider falsch: Das Layout von R Markdowns muss oft in HTML und CSS codiert werden. Deshalb nutzen wir in der Regel Templates. Teilen wir au√üerdem R Markdowns direkt (also nicht das Outputformat) ist auch die Nutzung in RStudio gar nicht so leicht - wie Ihr ja bereits wisst. Da m√ºssen wir also Zeit in das Set-up und die gute Erkl√§rung des Tools stecken.",
     allow_retry = TRUE,
     try_again_button = "Nochmal versuchen"
  ),
  
  question("Parameter sind...",
    answer("Platzhalter, die es erm√∂glichen einen Wert einmal zu definieren, und ihn an verschiedenen Stellen im Code zu √ºbergeben.", correct = TRUE),
    answer("eine Ma√üeinheit der Performance in der Computerwissenschaft."),
    correct = "Richtig! Gl√ºcklicherweise m√ºssen wir in der Computerwissenschaft keine 100 Parameter-Sprints laufen.",
    incorrect = "Leider falsch: Gl√ºcklicherweise m√ºssen wir in der Computerwissenschaft keine 100 Parameter-Sprints laufen.",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  ),
  question("Wie k√∂nnen Parameter gesetzt und √ºbergeben werden?",
    answer("√úber den YAML-Header, optional: Mit GUI", correct = TRUE),
    answer("In einer beliebigen Stelle im Code"),
    answer("√úber die Render-Funktion, optional: Mit GUI", correct = TRUE),
    correct = "Richtig! Dann kann es ja losgehen...",
    incorrect = "Leider falsch: Parameter werden √ºber den YAML-Header oder die Render-Funktion gesetzt.",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  )
)
```

### Interaktive √úbung

#### Schritt 0: Set-up

Zun√§chst ist es wichtig, die richtige Infrastruktur f√ºr Eure Reports zu schaffen. Eine Reportautomatisierung besteht aus:

-   einem **Reporttemplate in R Markdown**, in dem der Inhalt des Reports, der Code, und die Parameter im YAML-Abschnitt definiert werden (reporttemplate.Rmd)
-   einem **Ausf√ºhrungsskript**, das die render-Funktion zur automatischen Erstellung der Reports enth√§lt. Hier k√∂nnen verschiedene Optionen f√ºr den Prozess der Reportgenerierung eingestellt werden. Au√üerdem k√∂nnen Parameter Werte definiert werden, die dann √ºber die Platzhalter Parameter sogar in den Code des R Markdown Dokuments einflie√üen k√∂nnen und somit den generierten Report beeinflussen. (diese Dateien werden oft render.R oder render.Rmd genannt. Wir verwenden report_factory.Rmd)

Eingebettet sollten die beiden Codeskripte in einem **R-Projekt** sein. Wie bereits im Kapitel "Einf√ºhrung in R(Studio)" erkl√§rt, helfen diese als metaphorischer Umzugskarton unsere Infrastruktur zusammenzuhalten. Ein R-Projekt, das alle enthaltenen Dateien einbettet, erleichtert die √úbergabe der Werte zwischen den Dateien. N√ºtzlich sind zudem die **Ordner "daten"**, in dem alle Daten hinterlegt sind, sowie der **Ordner "out"**, in dem alle erzeugten Reports gespeichert werden.

#### Schritt 1: Parameter definieren (und ggf. Standardwert setzen)

Um Parameter zu nutzen, m√ºssen diese **immer** im YAML-Header definiert werden. Der folgende YAML-Header legt als Titel "Mein Report", als Autor:in "Maxi Mustermensch", als Datum den heutigen Tag (`r params$heute`) und als Output HTML fest. Dar√ºber setzen wir noch eigene Parameter (params). Jede Zeile folgt der Logik eines **Key-Value-Paares** (zu dt. Schl√ºssel-Wert-Paar). Die Bezeichnung des Wertes steht also vor dem Doppelpunkt, der Wert danach (`parameter_name(key): parameter_wert(value)`). Dieser Wert ist Euer Standardwert bei der Ausf√ºhrung des Codeskripts. Wenn der Wert frei bleibt, wird er automatisch auf `NULL` gesetzt.

```         
---
title: "Mein Report"
author: "Maxi Mustermensch"
date: "`r format(Sys.Date(), '%d. %B %Y')`"
output: html_document
params:
  heute: !r format(Sys.Date(), '%d. %B %Y')
  daten: "daten/audit.csv"
  filter_plastic: "hdpe"
  filter_continent: "alle Kontinente"
---
```

Ausgew√§hlt haben wir hier als Parameter das Ausstellungsdatum des Reports (den aktuellen Tag), Daten, Plastiktyp und einen Parameter mit diversen Auspr√§gungen (Kontinente), da dies Weichenstellungen sind, die wir bei der Erstellung und Aktualisierung von Reports h√§ufig austauschen.

*Anmerkung: Achtung bei der Nutzung von R-Funktionen in den allgemeinen YAML-Headereinstellungen und den Parametern. Die Syntax unterscheidet sich (siehe oben).*

#### Schritt 2: Parameter einbinden

Parameter, die im YAML-Abschnitt definiert wurden, stehen als **Liste namens `params`** zur Verf√ºgung. Um auf einen Parameter im Code zuzugreifen, benutzt Ihr `params$parameter_key`. Auf den Parameterwert k√∂nnt Ihr sowohl in Code Chunks als auch im Inhalt des R Markdowns zugreifen. Schauen wir uns das mal am Beispiel des Parameter "heute" an:

```         
Das heutige Datum ist: `r knitr::inline_expr('params$heute')` 
```

Beim Rendern des R Markdowns wird also der Platzhalter `params$heute` durch das Datum ersetzt, welches im YAML-Abschnitt definiert wurde. Aus dem Code wird also:\

```         
Das heutige Datum ist: `r params$heute`. 
```

Genauso funktioniert das Ganze auch f√ºr Code:

```{r, parameter_call, exercise = TRUE}
# Zugriff auf den Parameter "heute"
print(params$heute)
```

Druckt hier den als Parameter definierten Filter f√ºr Plastikart (`filter_plastic`).

```{r 11quiz_parameter_call, exercise = TRUE}
# Hier Euer Code!

```

```{r 11quiz_parameter_call-solution}
# Zugriff auf den Parameter "filter_plastic"
print(params$filter_plastic)
```

```{r 11quiz_parameter_call-check}
grade_this_code()
```

<!-- Die Parameter k√∂nnen wir dann nutzen, um Daten einzulesen...  -->

<!-- ```{r parameter_daten, exercise = TRUE} -->

<!-- # Daten mit Parameter laden -->

<!-- rio::import(here::here(params$daten), fill=TRUE) -->

<!-- ``` -->

Die Parameter k√∂nnen wir dann nutzen, um Daten zu filtern (wir nutzen hier den vorbereiteten Datensatz `audit`).

```{r parameter_filtern, exercise = TRUE}
# Laden des Audit-Datensatzes 
audit <- rio::import(
  here::here("daten/bffp2019_audit_by_country_and_company.csv")
  )
```

```{r 11quiz_1-parameter_filtern, exercise = TRUE}
# Filtern des Audit-Datensatzes 
audit %>%
  dplyr::filter(plastic_type == params$filter_plastic)
```

Filtert nun zus√§tzlich den Kontinent (hinterlegt als `filter_continent`):

```{r 11quiz_parameter_filter, exercise = TRUE}
# Filtern des Audit-Datensatzes (hinterlegt als )
audit %>%
  dplyr::filter(plastic_type == params$filter_plastic) 
# Euer Code hier
```

```{r 11quiz_parameter_filter-solution}
# Filtern des Audit-Datensatzes
audit %>%
  dplyr::filter(plastic_type == params$filter_plastic,
                continent == params$filter_continent)
```

```{r 11quiz_reportauto_filter}
quiz(caption = NULL,
  question("Wie viele Beobachtungen werden gefunden?",
    answer("2886"),
    answer("0", correct = TRUE),
    answer("178"),
    correct = "Richtig!",
    incorrect = "Leider falsch.",
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  ),
  question("Warum ist das der Fall?",
    answer("Es gibt f√ºr den Kontinent keine Beobachtungen.", correct = TRUE),
    answer("Das muss ein Fehler sein..."),
    correct = 'Richtig! Wir haben den Parameter "filter_continent" mit dem Standardwert "alle Kontinente" definiert. So einen Kontinent gibt es im Datensatz nat√ºrlich √ºberhaupt nicht. Es ist aber ein guter Trick, denn so k√∂nnt Ihr eine Bedingung einbauen: Nur wenn der Parameter spezifiziert ist (ungleich "alle Kontinente"), wird ein spezieller Report angelegt. Sonst wird der Report f√ºr den ganzen Datensatz erzeugt. Cool, oder?',
    incorrect = 'Leider falsch: Die Anzahl der Zeilen (= Beobachtungen betr√§gt 0, ablesbar in Description:df [0 √ó 16]. Wir haben den Parameter "filter_continent" mit dem Standardwert "alle Kontinente" definiert. So einen Kontinent gibt es im Datensatz nat√ºrlich √ºberhaupt nicht. Es ist aber ein guter Trick, denn so k√∂nnt Ihr eine Bedingung einbauen: Nur wenn der Parameter spezifiziert ist (ungleich "alle Kontinente"), wird ein spezieller Report angelegt. Sonst wird der Report f√ºr den ganzen Datensatz erzeugt. Cool, oder?',
    allow_retry = TRUE,
    try_again_button = "Nochmal versuchen"
  )
)
```

Umsetzen k√∂nnen wir die Option "alle Kontinente" √ºbrigens, indem wir beispielsweise in der Datenbereinigung diese Option einbauen:

```{r filter_trick, exercise = TRUE}
### Filter f√ºr parametrisierte Reports einf√ºgen
if (params$filter_continent != "alle Kontinente") {
  audit <- audit %>% filter(continent == params$filter_continent)
}

# Head drucken
head(audit)
```

#### Schritt 3: Parameter anpassen

##### Option A1: YAML-Header (begrenzt praktikabel)

Falls Ihr den Report lediglich semi-automatisch ausf√ºhren wollt, k√∂nnt Ihr die Parameter **manuell im YAML-Header** jederzeit austauschen und anpassen. Der Report wird dann auf Basis der aktualisierten Parameter durchgef√ºhrt (Klickt einfach auf "Knit").

##### Option A2: YAML-Header mit GUI (begrenzt praktikabel)

Neben dem Knit-Button findet sich ein Men√º, in dem "Knit with parameters..." ausgew√§hlt werden kann. Daraufhin √∂ffnet sich in R-Studio eine graphische Oberfl√§che, in der f√ºr die im R Markdown Dokument definierten Parameter eigene Werte eingegeben werden k√∂nnen.

![*Knitting mit Parametern - Standard (Screenshot)*](https://github.com/CorrelAid/lernplattform/blob/main/abbildungen/10_automatisierte-reports/knitwithparameters.png?raw=true){#id .class width="50%" height="50%"}

Das Layout der Parametereingabe k√∂nnt Ihr √ºber den YAML-Header sogar gestalten. Zur Verf√ºgung steht Euch die freie Eingabe (Standard), Dateiuploards (n√ºtzlich f√ºr Daten), Slider (f√ºr numeriswche Werte oder Datumsangaben) und ein Dropdown-Men√º zur Auswahl von Optionen. Au√üerdem k√∂nnt Ihr den Eingabefeldern individuelle Namen, ein Minimum und Maximum zuweisen.

```         
---
title: "Mein Report"
author: "Maxi Mustermensch"
date: "`r format(Sys.Date(), '%d. %B %Y')`"
output: html_document
params:
  heute: !r format(Sys.Date(), '%d. %B %Y')
  daten: #Parametername
    label: "Daten hochladen (CSV-Format):" #Beschreibung im Men√º
    value: "daten/audit.csv" #Standardwert
    input: file #Layoutoption: File-Upload
  filter_plastic: 
    value: "hdpe"
    label: "Plastikart ausw√§hlen:"
    choices: ["hdpe", "ldpe", "o", "pet", "pp", "ps", "pvc"] #Layoutoption: Einfachauswahl
  filter_continent: 
    label: "Kontinent ausw√§hlen:"
    value: "alle Kontinente"
    input: select #Layoutoption: Einfachauswahl
    choices: ["Amerikas", "Asien", "Afrika", "Europa", "Ozeanien", "alle Kontinente"] 
---
```

![*Knitting mit Parametern - Men√ºoptionen (Screenshot)*](https://github.com/CorrelAid/lernplattform/blob/main/abbildungen/10_automatisierte-reports/knitwithparametersoptions.png?raw=true){.class width="50%" height="50%"}

##### Option B1: Die Render-Funktion mit GUI (begrenzt praktikabel)

Die andere Option, die wir Euch nicht vorenthalten m√∂chten, ist das Starten des GUI √ºber die `rmarkdown::render()`-Funktion. Ansonsten funktionier hier alles analog zu Option A2.

``` r
rmarkdown::render("Report_Plastic.Rmd", params = "ask")
```

##### Option B2: Die Render-Funktion (Best Practice)

Am Besten - und wenn Ihr viele Reports auf einmal erstellen wollt - solltet Ihr nun die **Render-Datei** `render.R/render.Rmd` einrichten. Hauptbestandteil dieses Codescriptes ist die Render-Funktion:

``` r
rmarkdown::render(
  input = here::here("Report_Plastic.Rmd"), # Hier kommt Euer Reporttemplate hin
  output_format = "html_document", # Hier legt Ihr das Outputformat fest
  output_file = glue::glue("{lubridate::today()}_Report_{params$filter_continent}"), # Hier legt Ihr den Outputnamen fest
  output_dir = "output" # Hier legt Ihr den Ordner fest, in dem Output gespeichert wird
  params = list(filter_continent: "alle Kontinente") # Hier k√∂nnt Ihr die Parameterliste setzen
  ) 
```

</details>

## **Exkurs 2: Die Reportfabrik**

Wollen wir viele Reports auf einmal erstellen, m√ºssen wir die Render-Funktion in etwas einbetten, das definiert, dass der Report f√ºr die verschiedenen Werte in einer Liste gerendert werden soll. Wir nutzen dazu die `purrr::walk`-Funktion. Sie bedeutet: F√ºr jedes Element der Liste, wende die Funktion an, die hier definiert wird:

``` r
purrr::walk(liste, function(listenelement) {
  beliebige_function(beliebiges_argument = bezug_listenelement)
})
```

Wir wollen f√ºr den [Report Ausblick](https://drive.google.com/file/d/1vjfbibPdMfXuw0HQHL_0p4MeGO_kcYP2/view?usp=share_link){target="_blank"}, der bereits den Trick mit "alle Kontinente" enth√§lt, nun ein `render.R`-Skript erstellen, das auch zul√§sst, dass wir f√ºr jeden Kontinent einen Report erstellen. Dazu importierten wir im `render.R`-Skript den Audit-Datensatz und erstellen - analog zum Report - den Audit-Datensatz. Da wir f√ºr jeden Kontinent einen Report anlegen wollen, ben√∂tigen wir eine **Liste** der Kontinente.

``` r
# Liste mit Kontinenten erstellen
kontinente_liste <- unique(audit$continent)
```

Im Anschluss kombinieren wir die `purrr::walk()`-Funktion mit der `rmarkdown::render()`-Funktion.

``` r
purrr::walk(
    .x = kontinente_liste, 
    .f = ~rmarkdown::render(
    # Hier kommt Euer Reporttemplate hin
    input = here::here("11_reports-uebung_NH_Ausblick.Rmd"), 
    # Hier legt Ihr das Outputformat fest
    output_format = "html_document",
    # Hier legt Ihr den Outputnamen fest, der nun den Kontinent beinhaltet
    output_file = glue::glue("{lubridate::today()}_Report_{.x}"),
    # Hier legt Ihr den Ordner fest, in dem Output gespeichert wird
    output_dir = "output"
    # Hier k√∂nnt Ihr die Parameterliste setzen: Wir √§ndern nur den Parameter "Kontinent"
    params = list(filter_continent: "alle Kontinente") 
  )
```

*Tipp 1: Erstellt das zugeh√∂rige Directory automatisch, falls es nicht exisiert.*

``` r
output_dir <- here::here("output")
if (!dir.exists(output_dir)) {
  dir.create(output_dir)
}
```

*Tipp 2: Ihr wollt die Reports ganz automatisch ohne Euer Zutun erzeugen, z.B. auf einem Server? Daf√ºr nutzen wir CronJobs, die zeitbasiert Prozesse f√ºr uns ausf√ºhren. Wie √ºblich gibt es zum vereinfachten Management ein Package in R: [cron R Dokumentation](https://cran.r-project.org/web/packages/cronR/cronR.pdf){target="_blank"}*

Tolle Tipps, Tricks und mehr Input findet Ihr auf der [Website von R-Studio](https://rmarkdown.rstudio.com/lesson-6.html){target="_blank"}, in den englischsprachigen B√ºchern [Markdown: The Definite Guide, Kapitel 15](https://bookdown.org/yihui/rmarkdown/parameterized-reports.html){target="_blank"} und [R Markdown Cookbook, Kapitel 17.4](https://bookdown.org/yihui/rmarkdown-cookbook/parameterized-reports.html){target="_blank"} und bei [Dataquest](https://app.dataquest.io/course/intermediate-r){target="_blank"}. In dem verlinkten Kapitel findet Ihr insbesondere weitere Hilfestellungen zu Wenn-Dann-Bedingungen, Funktionen und Iterationen.

### **Und jetzt Ihr**

Wenn Ihr einen **eigenen Report** habt - den Ihr letzte Woche bereits in R erstellt habt - dann k√∂nnt Ihr jetzt versuchen, diesen mit Hilfe der `rmarkdown::render()` Funktion zu generieren und die Funktion so anzupassen, dass der Dateiname nach euren W√ºnschen Angepasst wird. Wenn Ihr nicht genug vom Report fabrizieren bekommen k√∂nnt oder Ihr keinen eigenen Report habt, dann schaut in den Ordner `10_automatisierte-reports/10_automatisiertereports` im [√úbungsordner](https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/CorrelAid/lernplattform/tree/main/uebungen){target="_blank"}, √∂ffnet das R Projekt und versucht die Aufgaben in `Report_Factory.Rmd` zu bearbeiten.

### **Zus√§tzliche Ressourcen**

-   [RStudio Webinar: **Rethink Reporting with Automation**](https://www.rstudio.com/resources/webinars/rethink-reporting-with-automation/){target="_blank"}
-   Yihui Xie et al. [**RMarkdown: The Definitive Guide**](https://bookdown.org/yihui/rmarkdown/parameterized-reports.html){target="_blank"} (engl.)
-   RStudios [Hilfeseite](https://rmarkdown.rstudio.com/lesson-6.html){target="_blank"}
-   [CorrelTalk: **Automatisierte Reportgenerierung f√ºr die Weltl√§den**](https://soundcloud.com/correlaid_podcast/about-correlaid-eine-interaktive-weltkarte-fur-erlassjahrde?utm_source=clipboard&utm_medium=text&utm_campaign=social_sharing){target="_blank"}
