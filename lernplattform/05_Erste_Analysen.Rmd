## Erste Datenanalysen in R

*dies sage ich im Video*

Was machen wir in dieser Einheit? Noch mehr Lust bekommen auf Arbeit mit Daten. Daher starten wir direkt mit einem Anwendungsbeispiel. Hier geht es darum große Konzepte kennenzulernen und so Details zu wie das genau alles implementiert wird, die im Kursverlauf kommen, besser einordnen zu können.

gern an einem eigenen datensatz nachmachen

Agenda der Einheit
0. Einlesen und Prep 
1. Mittels Visualisierung die Daten erschließen
2. Kompakte statistische Kennzahlen erstellen
3. Inferenz: Teststatistik erstellen und interpretieren

Datensatz von TidyTuesday vorstellen

https://de.wikipedia.org/wiki/Recycling-Code

https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-01-26


### Vorbereitung
``` {r Pakete laden, echo=FALSE,include=FALSE}

library(tidyverse)
library(janitor)
library(countrycode)

```



``` {r einlesen, include=FALSE}

plastics <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-01-26/plastics.csv')


```


``` {r Daten Struktur}
#@ Nina gern in 04 übernehmen...

str(plastics)

```

``` {r Daten Struktur 2}
#@ Nina gern in 04 übernehmen...

head(plastics)
tail(plastics)
```



``` {r Daten Struktur 3}
plastics %>%
        tabyl(country, year) %>%
          janitor::adorn_rounding(digits=2) %>%
          arrange(desc(`2019`))
```


``` {r Daten prep 1 , include=FALSE}

#@ Nina gern in 04 übernehmen...

# Country name cleaning: 
  #United Kingdom of Great Britain & Northern Ireland ssowie für die USA
plastics_prep <- plastics %>%
  # nur 2019 weil 2020 wegen der Pandemie ein nicht repräsentatives Jahr ist
  filter(year==2019) %>%
  mutate(country = str_replace(country, "United Kingdom of Great Britain & Northern Ireland", "United Kingdom"),
         country = str_replace(country, "United States of America", "United States")) %>%
  #Continent und country code anspielen
  mutate(continent = countrycode::countrycode(country, origin = "country.name", destination = "continent"),
         countrycode = countrycode::countrycode(country, origin = "country.name", destination = "iso3c")) %>%
  mutate(continent=replace_na(continent, "Unknown"),
         countrycode==replace_na(countrycode, "Unknown"))

``` 

``` {r Datensatz 1 community, include=FALSE}

community<- plastics_prep %>%
  select(country, year, num_events, volunteers, continent, countrycode) %>%
  group_by(country, year) %>%
  filter(row_number()==1)

``` 

``` {r Datensatz 2 audit firm, include=FALSE}

audit_firm<- plastics_prep %>%
  select(country, year, parent_company, grand_total, continent, countrycode) %>%
  # grandtotal zeilen löschen - ist schon in einer Spalte erfasst
  filter(parent_company!="Grand Total")

``` 

``` {r Datensatz 3 audit plastik, include=FALSE}

audit_plastic<- plastics_prep %>%
  
  # nur grandtotal zeile behalten
  filter(parent_company=="Grand Total") %>%
  select(-c(parent_company, num_events, volunteers))


``` 

Schau Dir an, wie die ersten Zeilen des `audit_plastic` Datensatz gefüllt sind.

``` {r ersten5-zeilen, exercise=TRUE}
head(audit_plastic)

```

Welche Werte nehmen die Variablen "pvc" und "empty" an? Letzeres sind Plastikteile, die gefunden aber nicht klassifiziert wurden. Prüfe dies mit dem folgenden Code Snippet.

``` {r empty-pvc-kategorie, exercise=TRUE}

audit_plastic %>%
  tabyl(empty)

``` 
```{r frage1, echo=FALSE}
question("Welche Werte nehmen die Variablen 'pvc' nicht an?",
  answer("9"),
  answer("24"),
  answer("0", correct = TRUE),
  answer("188")
)

question("Welche Werte nehmen die Variablen 'empty' an?",
  answer("0"),
  answer("0 oder NA", correct = TRUE),
  answer("11"),
  answer("188")
)
```

```{r empty-loschen, exercise=TRUE, exercise.eval=TRUE}

audit_plastic<- audit_plastic %>%
  select(-empty)

```

```{r empty-loschen-hint}

audit_plastic<- audit_plastic %>%
  select(-empty)

```

Alle 'NA' Ausprägungen, wandeln wir in 0 um. Das ist keine allgemeingültig richtiger Umgang mit fehlenden Werten, aber für `audit_plastic` ergibt das Sinn.

```{r na-in-zero, exercise=TRUE}

audit_plastic<- audit_plastic %>%
 mutate(
    across(everything(), ~replace_na(.x, 0))
  )
```




### 1 Visuelle Exploration 


*dies sage ich im Video*

### Kernaussagen

- Wichtig erst viz dann statistik!
- Ein Q&A mit den Daten machen - mit dem Wissen der Aktion, welche Fragen würdet ihr den Daten stellen wollen?

- `ggplot2` ist das Paket für gute Graphen in R.
- Es folgt der "Grammar of graphics".
- Die Syntax entsteht Schicht-für-Schicht. Einzelne Bestandteile werden mit einem '+' hinzugefügt.
- Die wichtigsten Schichten (Bestandteile) eines ggplots sind: 

1. `data` - Der Datensatz.
2. `aes()` - Die ästhetischen Attribute wie die x- oder y-Achse.
3. `geom_*()` - Die geometrische Form, mit welcher die Werte dargestellt werden,



Meine Ideen:

Community Perspektive  
  - Wie viele Teilnehmer? Insgesamt und nach Ländern?
  - Wie viele Events?

Activism/ Audit Perspektive
  - Wievele Firmen? Insgesamt und nach Ländern?
  - Wieviel Plastik vo welcher Sorte?
  
- layered grammar
- r4ds inspirierte Vorstellung von ggplot2

https://github.com/allisonhorst/stats-illustrations/

Cedrics Blog verlinken


Beginnen wir mit der Community-Perspektive und dem Grundgerüst einer ggplot Graphik: dem Erstellen eines ggplot-Objekt und der Definition von ästgetischen Attributen. Das sind zum Beipiel die Variablen bzw. Spalten, die auf der x-und y-Achse dargestellt werden sollen. Was produziert dieser Code Snippet? Was passiert, wenn ihr die Variablen vertauscht?

```{r grahik1, echo=FALSE}

community %>%
  ggplot(aes(continent, volunteers))

```

Nun fügen wir ein `geom` hinzu. 

```{r geom-point1, echo=FALSE}

community %>%
  ggplot(aes(continent, volunteers)) +
  geom_point()

```



```{r geom-point2, echo=FALSE}

community %>%
  ggplot(aes(continent, volunteers)) +
  geom_point(position = "jitter")

```
Finden heraus wer diese extreme Beobachtung ist.


```{r extreme-beob, exercise=TRUE}

community %>%
  filter(volunteers>20000)

```

Welche Möglichkeiten seht ihr, mit dieser Beobachtung umzugehen?

```{r geom-point3, echo=FALSE}

community %>%
  filter(countrycode!=TWN) %>%
  ggplot(aes(continent, volunteers)) +
  geom_point(position = "jitter") + 
  labs(caption = "In Taiwan haben sich 31318 Freiwillige beteiligt. Diese Beoachtung wurde zur Lesbarkeit des Graphen ausgeklammert.")
  # Bonus: 
  #ggannotate with arrow.. ("Taiwan recorded \n 31318	volunteers") +
  
  

```


```{r grahik7, echo=FALSE}

community %>%
  ggplot(aes(volunteers, continent)) +
  geom_bar(stat="identity")

```


```{r grahik3, echo=FALSE}

community %>%
  ggplot(aes(volunteers, reorder(continent, volunteers))) +
  geom_bar(stat="identity", position="dodge") +
  labs(title = "Beteiligung an 'Break free from Plastik' ..." ,
      subtitle= "... unterscheidet sich nach Kontinent",
      x = "Anzahl Freiwilliger",
      y = "Kontinent") +
  theme_minimal()
  
```


```{r grahik4 anderes geom, echo=FALSE}

community %>%
  ggplot(aes(reorder(continent, volunteers),volunteers)) +
  geom_jitter(width = .1, alpha=0.75) +
  labs(title = "Beteiligung an 'Break free from Plastik' ..." ,
       subtitle= "... unterscheidet sich nach Kontinent.",
       x = "Anzahl Freiwilliger",
       y = "Kontinent") +
  theme_minimal()

```


```{r grahik5 outlier ausklammern anderes geom, echo=FALSE}

community %>%
  filter(countrycode!="TWN") %>%
  ggplot(aes(reorder(continent, volunteers), volunteers)) +
  geom_jitter(width = .2, alpha=0.6, size=3) +
  labs(title = "Beteiligung an 'Break free from Plastik' ..." ,
       subtitle= "... unterscheidet sich nach Kontinent.",
       x = "Anzahl Freiwilliger",
       y = "Kontinent") +
  theme_minimal()

```

```{r graph übung, echo=FALSE}
#Diese Graphik für firmen perspektive oder Plastik audit perspektive erstellen

```



### Exploration mit statistischen Kennzahlen

https://github.com/allisonhorst/bren-phd-workshop-r-materials/blob/master/day_4_r_materials/day_4_part_2_key.R

dplyr::group_by + summarize - a powerful combo

```{r Kurz Statistik}
summary(plastics)
```


```{r Gruppieren Statistik und Statistik ausgeben}


```


```{r audit Perspektive: Gruppieren Statistik und Statistik für top 3 ausgeben}


```


### Teststatistik 

*Sage ich im Video*

- Spirit: Evaluation
- Achtung - hier bewegen wir uns auf theoretisch gesehen auf neuem Territorium: Inferenzstatistik: wir schließen von unserer Stichprobe auf die Grundgesamtheit. Die Programmierung ist simple, damit es auch von der Interpretation her sinnvoll ist, müssen einige Annahmen gelten. Diese leiten wir hier nicht her, verweisen aber auf entweder euer Statistikwissen/ Nachschlagewerk oder: https://www.youtube.com/watch?v=RRIsBFW8ovc (2-sample test) oder https://www.youtube.com/watch?v=MCmZ-HXSZ4A (chi2 Test)
- mögliche Fragen:
  
  *Community Perspektive*
  - mehr durchschnittliche Teilnehmer pro Event? (Länder im Vgl)
  
  *Advocacy Perspektive*
  - Unterscheiden sich die Anteile der Firmen/Plastik der top3 signifikant voneinander?
  
https://github.com/allisonhorst/bren-phd-workshop-r-materials/blob/master/day_6_r_materials/day_6_key.Rmd


### Resourcen ZUsammenfassung

- r4ds
- https://www.cedricscherer.com/2019/08/05/a-ggplot2-tutorial-for-beautiful-plotting-in-r/