---
title: "Report Fabrik"
output:
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r}
# Notwendige Packages laden
pacman::p_load(
  glue,
  here,
  lubridate,
  rmarkdown,
  tidyverse
)

url_audit <- "https://raw.githubusercontent.com/CorrelAid/lernplattform/main/daten/bffp2019_audit_by_country_and_company.csv"

audit_raw <- rio::import(file = url_audit) %>%
  # Unpassende Werte Filtern
  dplyr::filter(!parent_company %in% c("Unbranded", "Inconnu", "Assorted"))

audit <- audit_raw
```

# Willkommen in der Report Fabrik

Im Folgenden nutzen wir den bisher erstellten Report aus der letzen Woche. In dieser √úbung geht es darum, diesen Report auf verschiedene Weise zu generieren ohne dabei den Knit-Button per Hand zu dr√ºcken. Damit erreichen wir, dass wir bestimmte Verhaltensweisen durch sogenannte Parameter automatisiert ver√§ndern k√∂nnen, ohne im Dokument selbst etwas √§ndern zu m√ºssen. Denn daf√ºr haben wir die Parameter als Platzhalter dienen.

Let's go!


# Schritt 1: rmarkdown::render() Funktion

Rendert das `Report_Plastic.Rmd` oder ein .Rmd Eurer Wahl mit der `rmarkdown::render()` Funktion, anstatt des üß∂ Knit-Buttons. Ihr k√∂nnt den Code daf√ºr in diesem Dokument sammeln. Hier ist sozusagen Eure Report-Factory, in der ihr den Code schreibt, der dann die Reports generiert. 

*\*Anmerkung: Falls Ihr die render Funktion nachschlagen m√∂chtet, k√∂nnt Ihr den Namen der Funktion entweder im Help-Abschnitt von R-Studio eingeben oder die Funktion im Script highlighten und dann F1 dr√ºcken. Ein weiterer Weg ist es, `?render` in der Console auszuf√ºhren*

```{r}
# hier dein Code um einen Report mit rmarkdown::render() zu generieren
rmarkdown::render(input = "Report_Plastic.Rmd")
```


# Schritt 2:  Output Datei umbenennen

Probiert Euch nun an dem `output_file` argument der rmarkdown::render Funktion:  
- setzt dort den Namen fest, den Eurer Report sp√§ter haben soll
```{r}
rmarkdown::render(
  input = "Report_Plastic.Rmd",
  output_file = "Plastik-Report_Europa"
)
```


# Schritt 3: Input vom Code trennen

Automatisiert die Erstellung des Output Namens Eures Reports mit Hilfe der `glue::glue()` Funktion. √úberlegt Euch welche Teile des Report-Namens sich eventuell oft √§ndern k√∂nnen (zum Beispiel das Datum). 

Passt den untenstehenden Code eventuell an, damit er mit Euren Reports funktioniert.

## 3.1 Input definieren
```{r define-input}
set_rmd_name <- "Report_Plastic.Rmd"

# Einzelteile des Report Namens
set_continent <- "Europa"
set_report_name <- "Plastik-Report"

# Dokumentnamen erstellen / zusammenkleben
output_file_name <- glue::glue("{set_report_name}_{set_continent}")
```

## 3.2 Report mit Namen erstellen 
Generiere nun einen Report mit automatisierter Benennung, den du in der Input-Abschnitt der Report-Factory festgelegt hast:
```{r}
rmarkdown::render(
  input = here::here(set_rmd_name),
  output_file = output_file_name
)
```

# Schritt 4: YAML Optionen √§ndern 
Nun geht es weiter mit dem `output_format` Argument. K√∂nnt ihr den untenstehenden Code so anpassen, dass ein PDF Dokument anstatt einer Website generiert wird?  

*\*Anmerkung: Falls Ihr die render Funktion nachschlagen m√∂chtet, k√∂nnt Ihr den Namen der Funktion entweder im Help-Abschnitt von R-Studio eingeben oder die Funktion im Script highlighten und dann F1 dr√ºcken. Ein weiterer Weg ist es, `?render` in der Console auszuf√ºhren*

```{r render-one}
rmarkdown::render(
  input = set_rmd_name,
  output_file = output_file_name,
  output_format = "html_document"
)
```

Was passiert wenn du das Argument `output_dir` verwendest? Schaue im Hilfe-Abschnitt der render Funktion nach diesem Argument und probiere es dann mit dem untenstehenden Code Block selbst aus. Wa spassiert, wenn ihr das `output_dir` Argument etwas √§ndert?

> der generierte Report wird jetzt nicht mehr im Haupt-Ordner des R-Projektes erstellt, sondern in einem von uns durch die `output_dir` definierten Ordner. In diesem Falle hei√üt der Ordner `output`.

```{r}
rmarkdown::render(
  input = set_rmd_name,
  output_file = output_file_name,
  output_dir = "output", # diese Zeile ist neu!
  output_format = "html_document"
)
```

# Schritt 5: Parameter kennenlernen
Schaut in den Beispiel Report `Report-Plastic.Rmd` und finde die Stelle, an der die Parameter definiert werden. 

> Dort finden wir den Parameter: `filter_continent`

Welchen Parameter k√∂nnt Ihr dort entdecken? 

> Die Stelle ist ganz oben im Skript zu finden.  

*\*Anmerkung: Erinnert Euch, Parameter bestehen immer aus Key: Value Paaren - √ºbersetzt Schl√ºssel: Wert Paaren. Dabei steht der Schl√ºssel vor dem Doppelpunkt und der Wert folgt danach.*

# Schritt 6: Parameter nutzen

F√ºhrt die folgenden beiden Code Bl√∂cke aus und vergleicht die erstellten Reports. 

- K√∂nnt ihr die Stelle im Code in diesem Dokument finden, die zu dem Unterschied gef√ºhrt hat? 

> Einmal ist der Parameter `filter_continent` als Europa definiert und einmal Ozanien.  Dadurch √§ndert sich die Art und Weise wie der Report gerendert wird. Einmal basiert der Report auf den Daten Europas und einmal auf den Daten f√ºr Ozeanien. 

- Findet ihr auch die Stelle im R Markdown Dokument, der zu dem Ergebnis beigetragen hat?

> im R-Markdown Dokument wird der Parameter den wir ver√§ndert haben in Zeile 16 im YAML Abschnitt definiert und dann in Zeile 61 im wrangle-data-subset-continent Code-Chunk eingesetzt. 
Der Parameter dient dort als Platzhalter, um die Daten f√ºr den ausgew√§hlten Kontinent zu filtern. Au√üerdem wird der Name des definierten Kontinents in die √úberschrift in Zeile 79 eingesetzt.

```{r example-europa}
rmarkdown::render(
  input = here::here("Report_Plastic.Rmd"),
  output_file = "output/√úbungsreport-Europe",
  output_format = "html_document",
  params = list(filter_continent = "Europe")
)
```

```{r example-ozeanien}
rmarkdown::render(
  input = here::here("Report_Plastic.Rmd"),
  output_file = "output/√úbungsreport-Ozeanien",
  output_format = "html_document",
  params = list(filter_continent = "Ozeanien")
)
```

# Schritt 6: Parameter recyclen

Nun ist es soweit, wir wollen Reports erstellen die jeweils einen anderen Kontinent hervorheben. F√ºhre daf√ºr die folgenden Code Bl√∂cke aus

1. Kontinente extrahieren
```{r}
continent_names <- audit_raw %>%
  dplyr::distinct(continent) %>%
  dplyr::pull(continent)
```

An den Kontinenten in `continent_names` "laufen" wir entlang und √ºbergeben den Kontinentnamen an unsere render Funktion (siehe .x). Noch genauer √ºbergeben wir sie an die Stelle in der render Funktion an der die Parameter f√ºr das R Markdown Dokument festgelegt werden k√∂nnen.
```{r}
purrr::walk(
  .x = continent_names,
  .f = ~ rmarkdown::render(
    input = here::here(set_rmd_name),
    output_file = glue::glue("{set_report_name}_{.x}"),
    output_format = "html_document",
    # hier wird der Kontinentname √ºbergeben
    params = list(filter_continent = .x)
  )
)
```


# Bonus

Probiere mit dem gleichen Prinzip, Reportsversionen f√ºr alle L√§nder zu generieren, indem du einen den Parameter `filter_continent` mit `filter_country` ersetzt und die entsprechenden Stellen im Code anpasst.

```{r}
# hier wird ein Objekt der die verschiedenen Optionen enth√§llt erstellt
country_names <- audit_raw %>%
  dplyr::distinct(country) %>%
  dplyr::pull(country)
```

```{r}
# Hier Eurer Code
purrr::walk(
  .x = country_names,
  .f = ~ rmarkdown::render(
    input = here::here(set_rmd_name),
    output_file = glue::glue("output/{set_report_name}_{.x}"),
    output_format = "html_document",
    # hier wird der Landname √ºbergeben
    params = list(filter_country = .x)
  )
)
```
