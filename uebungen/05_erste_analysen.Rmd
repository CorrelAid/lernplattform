---
title: "Erste Analyse in R"
author: "Sylvi Rzepka"
date: "10/17/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(janitor)
library(countrycode)
library(here)
```

## Vorbereitung


``` {r einlesen und aufbereiten, include=FALSE}
# Daten laden
plastics <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-01-26/plastics.csv')


# Country name cleaning: United Kingdom of Great Britain & Northern Ireland sowie für die USA
plastics_prep <- plastics %>%
  # nur 2019 weil 2020 wegen der Pandemie ein nicht repräsentatives Jahr ist
  filter(year==2019) %>%
  mutate(country = str_replace(country, "United Kingdom of Great Britain & Northern Ireland", "United Kingdom"),
         country = str_replace(country, "United States of America", "United States"),
         country = str_to_title(country) ) %>% #um z.B.: ECUADOR etc case ändern
  #Continent und country code anspielen
  mutate(continent = countrycode::countrycode(country, origin = "country.name", destination = "continent"),
         countrycode = countrycode::countrycode(country, origin = "country.name", destination = "iso3c")) %>%
  mutate(continent=replace_na(continent, "Unknown"),
         countrycode=replace_na(countrycode, "Unknown"))

# Community Datensatz für 05
community<- plastics_prep %>%
  select(country, year, num_events, volunteers, grand_total, continent, countrycode) %>%
  group_by(country, year) %>%
  filter(row_number()==1)

# Audit plastik Datensatz 

audit_plastic<- plastics_prep %>%
  # nur grandtotal zeile behalten
  filter(parent_company=="Grand Total") %>%
  select(-c(parent_company, num_events, volunteers, empty)) %>%
  #NA zu 0
  mutate(
    across(everything(), ~replace_na(.x, 0))
  )

# EU-Asien Audit plastik Datensatz 
audit_plastic_eu_asia<- audit_plastic %>%
  filter(continent == "Europe" | continent == "Asia") %>%
  group_by(country) %>%
  mutate(n_types=sum(c(hdpe, ldpe, o, pet, pp, ps, pvc)!=0))
```


In dieser Einheit geht es darum, in den Analyse-Spirit zu kommen und R als Analysetool kennenzulernen. Wir starten direkt mit einem Anwendungsbeispiel zu Teildatensätzen von "Breaking free from plastic". Schau Dir an, wie die ersten Zeilen des `community` Datensatz gefüllt sind.

``` {r ersten5-zeilen, }
head(community)

```

Zunächst müssen wir überprüfen Wie viele fehlende ("NA") Ausprägungen im Datensatz sind. Lass den Code Chunk laufen, um dies herauszufinden.


```{r na-in-zero}

table(is.na(community))

summary(is.na(community))


```


### 1 Visuelle Exploration 


Wir beginnen mit dem Grundgerüst einer `ggplot`-Graphik: dem Erstellen eines `ggplot`-Objekt und der Definition von ästhetischen Attributen. Das sind zum Beipiel die Variablen bzw. Spalten, die auf der x-und y-Achse dargestellt werden sollen. Was produziert dieser Code Snippet? Was passiert, wenn ihr die Variablen vertauscht?

```{r grahik1}

community %>%
  ggplot(aes(continent, volunteers))

```

Nun fügen wir ein `geom_point` hinzu. 

```{r geom-point1}

community %>%
  ggplot(aes(continent, volunteers)) +
  geom_point()

```

Mit `position = position_jitter(width=0.3)` schaffen wir es, dass die Punkte sich nicht alle überlagern. Mit `alpha = 0.6` werden die Punkte etwas transparent, mit `size=3` etwas größer und so auch einzeln besser sichtbar.


```{r geom-point2}

community %>%
  ggplot(aes(continent, volunteers)) +
  geom_point(position = position_jitter(width=0.3), size=3, alpha = 0.6)

```

Findet heraus, welches Land hinter dieser extreme Beobachtung steckt


```{r extreme-beob}

community %>%
  filter(volunteers>20000)

```

Welche Möglichkeiten seht ihr, mit dieser Beobachtung umzugehen? Eine Möglichkeit: Mit `coord_cartesian(ylim=c(0,10000))` können wir den Achsenauschnitt einschränken.

```{r geom-point3}

community %>%
  ggplot(aes(continent, volunteers)) +
  geom_point(position = position_jitter(width=0.3), size=3, alpha = 0.6) + 
  coord_cartesian(ylim=c(0,10000)) 


```

Anmerkungen sind ganz wesentliche Bestandteile einer Graphik. Neben Titel, Achsenbeschriftung wäre hier auch ein Hinweis auf die Datenquelle sowie die nichtdargestellte Beobachtung sinnvoll. Dies lässt sich alles über `labs()` in die Graphik einfügen. Mit `\n` könnt ihr händisch Zeilenumbrüche einfügen.

```{r geom-point4}

community %>%
 ggplot(aes(continent,  volunteers)) +
  geom_point(position = position_jitter(width=0.3), size=2, alpha = 0.6) + 
  coord_cartesian(ylim=c(0,10000)) +
  labs(title = "Die Beteiligung an 'Break free from Plastik' ..." ,
       subtitle= "... unterscheidet sich je nach Kontinent.",
       y = "Anzahl Freiwilliger",
       x = "Kontinent",
       caption = "In Taiwan haben sich 31318 Freiwillige beteiligt. Diese Beoachtung \nwurde zur Lesbarkeit des Graphen ausgeklammert. \nDatenquelle: TidyTuesday und BFFP") 

```

Den letzten Schliff können wir dem Layout geben, in dem wir den Stil über `theme_()` ändern. Zum Beispiel mit `theme_minimal()`. Zu dem können wir mit `reorder()` die Kontinente nach aufsteigender Teilnehmerzahl sortieren.

```{r geom-point5}

community %>%
  ggplot(aes(reorder(continent, volunteers), volunteers)) +
  geom_point(position = position_jitter(width=0.3), size=3, alpha = 0.6) + 
  coord_cartesian(ylim=c(0,10000)) +
  labs(title = "Die Beteiligung an 'Break free from Plastic' ..." ,
       subtitle= "... unterscheidet sich nach Kontinent.",
       y = "Anzahl Freiwilliger",
       x = "Kontinent",
       caption = "In Taiwan haben sich 31318 Freiwillige beteiligt. Diese Beoachtung \nwurde zur Lesbarkeit des Graphen ausgeklammert. \nDatenquelle: TidyTuesday und BFFP") +
  theme_minimal()

```

Für die Analyse der Frage: wo haben sich wie viele Freiwillige an *Breaking Free From Plastic* beteiligt? Könnten wir auch ein Balkendiagramm nutzen. `geom_bar(stat="identity")` summiert direkt die Freiwilligenanzahl je Kontinent. 

```{r geom_bar1}

community %>%
  ggplot(aes(volunteers, continent)) +
  geom_bar(stat="identity")

```

Hier könnte es sinnvoll sein, die Beobachtungen Kontinent "unkonwn" auszuklammern und nach der Gesamtzahl der Freiwilligen zu sortieren. Dies erreichen wir mit `filter()` direkt nach dem Datensatz.

```{r geom_bar2}

community %>%
  filter(continent != "Unknown") %>%
  ggplot(aes(volunteers, reorder(continent, volunteers))) +
  geom_bar(stat = "identity")
  
  
```

Auch hier ist es wichtig, die Graphik gut zu beschriften. 

```{r geombar3}

community %>%
  filter(continent != "Unknown") %>%
  ggplot(aes(volunteers, reorder(continent, volunteers))) +
  geom_bar(stat = "identity") +
  labs(title = "Die Beteiligung an 'Break free from Plastic' ..." ,
      subtitle= "... unterscheidet sich je nach Kontinent.",
      x = "Gesamtzahl an Freiwilligen",
      y = "Kontinent") +
  theme_minimal()
  
```

Mit `ggsave` kann man die Datei speichern. 

```{r geombar4}

ggsave(here("community_bargraph.jpg"))

```


#### Visualisierung Übung 
In der Einheit haben wir uns bei der Visualisierung vor allem der *Community Perspektive* gewidmet. Nun blicken wir auf die *Audit Perspektive*: Wie viel Plastik wurde wo für *Breaking Free From Plastic* gesammelt? Erstelle ein Punktediagramm (Scatterplot) mit dem Datensatz `audit_plastic` für diese *Audit Perspektive*. Die Graphik soll `grand_total`, die Anzahl der gesammelten Plastikstücke auf der y-Achse und die Kontinente auf der x-Achse zeigen.


### Exploration mit statistischen Kennzahlen

Kurzstatistiken lassen sich ausgeben mit `summary()`

```{r Kurz_Statistik}
summary(audit_plastic)
```

Kennzahlen können auch einzeln berechnet werden mittels `summarize`. Dies hat den Vorteil, dass ein kompaktes R-Objekt entsteht (ein `tibble`), das wir abspeichern können und auch weiterverwenden. 

```{r summarize_einfuhrung}

audit_plastic %>%
  summarize(menge_mittelw=mean(grand_total))

```

Eine sehr nützliche Kombination ist: `group_by()` und `summarize()`. Damit können wir erst Daten gruppieren, hier zum Beispiel nach Kontinenten, und dann Kennzahlen wie den Mittelwert und die Standardabweichung der gefundenen Plastikstücke pro Kontinent berechnen lassen. 

```{r gruppieren}

audit_plastic %>%
  group_by(continent) %>%
  summarize(menge_mittelw = mean(grand_total),
            menge_sd = sd(grand_total)) 

```

Weitere interessante Kennzahlen sind: der Median (`median()`), die Länderanzahl (`n()`) und die Summe aller gesammelten Plastikstücke (`sum()`). Ergänzt den Code um diese beiden Kennzahlen. 

```{r gruppieren2}

audit_plastic %>%
  group_by(continent) %>%
  summarize(menge_mittelw = mean(grand_total),
            menge_sd = sd(grand_total)) 

```

```{r gruppieren2-solution}
audit_plastic %>%
  group_by(continent) %>%
  summarize(menge_mittelw = mean(grand_total),
            menge_sd = sd(grand_total),
            menge_median = median(grand_total),
            länderanzahl = n(),
            summe_plastik = sum(grand_total)) 
```


Im Folgenden beschränken wir unsere Analyse auf Europa und Asien, wo sich am meisten Länder beteiligt haben. Hierfür haben wir bereits den `audit_plastic_eu_asia` Datensatz erstellt, der nur Europa und Asien enthält sowie eine neue Variable: `n_types`. Sie gibt an wie viele unterschiedliche Plastikarten in den einzelnen Ländern gesammelt wurden. 

Vergewissern wir uns, wie dieser Datensatz aussieht mit `head()`.

```{r head_eu_asia, exercise = TRUE}

head(audit_plastic_eu_asia)

```

Wie viele unterschiedliche Plastikarten werden in den asiatischen und europäischen Ländern aufgesammelt? Wie groß war die Streuung je Kontinent?


```{r durchschnitt, exercise = TRUE}
audit_plastic_eu_asia  %>%
  group_by(continent) %>%
  summarize(n_types_mean = mean(n_types),
            n_types_sd = sd(n_types))

```


### Exkurs: Teststatistik 

  
```{r ttest, exercise = TRUE}
#Anzahl plastikarten je Kontinent gleich?
t.test(audit_plastic_eu_asia$n_types ~ audit_plastic_eu_asia$continent)

```  
  

### Übung

Diese Woche möchten wir die Präsenzzeit nutzen, um die folgenden Übungen zu besprechen. Kommt gerne mit euren Ideen Fragen Anregungen oder Kommentaren zu diesem Input. Es ist nicht schlimm, wenn diese Woche noch gar nichts (komplexes) klappt, da die strukturierte Einführung in R noch folgt. In dieser Einheit ging es erst einmal darum, das R-Eis zu brechen und in den Analyse Spirit einzutauchen.

1. Zur Diskussion: Welche Fragen möchtet ihr den Daten noch stellen? Wie könnte eine Visualisierung oder eine zusammenfassende Statistik dabei helfen? Skizziert diese gern auf dem Papier bzw. überlegt 

2. Versucht das zugehörige R Markdown zum Laufen zu bringen und es nachzuvollziehen.

3. In der Einheit haben wir uns bei der Visualisierung vor allem der *Community Perspektive* gewidmet. Nun blicken wir auf die *Audit Perspektive*: Wie viel Plastik wurde wo für *Breaking Free From Plastic* gesammelt? Erstelle ein Punktediagramm (Scatterplot) mit dem Datensatz `audit_plastic` für diese *Audit Perspektive*. Die Graphik soll `grand_total`, die Anzahl der gesammelten Plastikstücke auf der y-Achse und die Kontinente auf der x-Achse zeigen.

4. Nutzt den `community` Datensatz und erstellt eine Tabelle, welche die Länder- und Teilnehmeranzahl je Kontinent darstellt.

